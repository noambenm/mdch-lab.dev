apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: test

namePrefix: frontend-

labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: podinfo

resources:
- ../../base/release.yaml
- ../../base/canary.yaml
- ../../base/scaledobject.yaml
- ../../base/servicemonitor.yaml

patches:
- patch: |-
    - op: replace
      path: /spec/targetRef/name
      value: frontend-podinfo
    - op: replace
      path: /spec/autoscalerRef/name
      value: frontend-podinfo-so
  target:
    group: flagger.app
    version: v1beta1
    kind: Canary
    name: podinfo-canary
- patch: |-
    - op: replace
      path: /spec/scaleTargetRef/name
      value: frontend-podinfo
  target:
    group: keda.sh
    version: v1alpha1
    kind: ScaledObject
    name: podinfo-so
- patch: |-
    - op: add
      path: /spec/selector/matchLabels/app.kubernetes.io~1component
      value: frontend
  target:
    group: monitoring.coreos.com
    version: v1
    kind: ServiceMonitor
    name: podinfo
- patch: |-
    - op: add
      path: /spec/values
      value:
        backend: http://backend-podinfo:9898/echo
  target:
    group: helm.toolkit.fluxcd.io
    version: v2
    kind: HelmRelease
    name: podinfo